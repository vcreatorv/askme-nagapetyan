{% extends 'layouts/base.html' %}
{% load bootstrap5 %}

{% load static %}

{% block style%}
<style>
 .badge {
    text-decoration: none;
    font-weight: normal;
}

.form-check-input {
    width: 25px; 
    height: 25px;
}
</style>
<link rel="stylesheet" href="{% static 'css/like_button.css' %}">
{% endblock %}


{% block content %}
<div class="question-container d-flex flex-column gap-3 mb-5">
    <div class="question-card card border-0 w-100 rounded-0 pb-2 border-bottom border-2 border-dark" data-question-id="{{question.id}}" data-is-liked="{{ is_liked }}" style="width: 18rem;">
        <div class="card-body">
            <div class="row">
                <div class="col-2">
                    <div class="mb-2" style="height: 130px">
                        <img src="{{ question.author.profile.avatar.url }}" alt="Avatar" class=" rounded-1 img-fluid h-100 w-100 object-fit-cover">
                    </div>
                     <button class="like-button">
                        <div class="heart"></div>
                        <div class="like-count">{{ question.like_count }}</div>
                     </button>
                </div>
                <div class="col-10">
                    <h5 class="card-title fs-3">{{ question.title }}</h5>
                    <p class="card-text">{{ question.content }}</p>
                    <div class="d-flex gap-2">
                        Tags:
                        {% for tag in question.tags.all %}
                            <a href="{% url 'tag' tag.id %}" class="card-link">{{ tag.name }}</a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if page_obj %}
    <div class="answers d-flex flex-column gap-3 rounded-0 pb-3 border-bottom border-2 border-dark">
        {% for answer in page_obj %}
        <div class="answer-card card w-100" id="answer-{{ answer.pk }}" data-is-liked="{{ answer.is_liked }}" style="width: 18rem;">
            <div class="card-body">
                <div class="row">
                    <div class="col-2">
                        <div class="mb-2" style="height: 130px">
                            <img src="{{ answer.author.profile.avatar.url }}" alt="Avatar" class=" rounded-1 img-fluid h-100 w-100 object-fit-cover">
                        </div>
                         <button class="like-button">
                            <div class="heart"></div>
                            <div class="like-count">{{ answer.like_count }}</div>
                         </button>
                    </div>

                    <div class="col-10">
                        <p class="card-text">{{ answer.content|linebreaksbr }}</p>
                        <div class="d-flex align-items-center gap-3">
                            {% if user.is_authenticated and user == answer.question.author %}
                                <input type="checkbox" class="m-0 form-check-input" id="checkbox-{{ answer.id }}" {% if answer.helpful %}checked{% endif %}>
                                <label class="helpful-label form-check-label" for="checkbox-{{ answer.id }}">
                                    {% if answer.helpful %}
                                        It was helpful!
                                    {% else %}
                                        Not checked
                                    {% endif %}
                                </label>
                            {% else %}
                                {% if answer.helpful %}
                                    <div class="d-flex align-items-center">
                                        <img src="{% static 'img/answer_check_mark.png' %}" alt="CheckMark" class="me-3" style="width: 20px; height: 20px;">
                                        <p class="mb-0">It was helpful!</p>
                                    </div>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        {% if page_obj.paginator.count > 1 %}
            {% include 'components/pagination.html' with page_obj=page_obj %}
        {% endif%}
    </div>
    {% endif%}

    <form method="POST">
        {% csrf_token %}
        <div class="form-floating p-0 pt-3">

            {% bootstrap_form form %}

            {%  buttons %}

            <div class="row-3 gap-3">
                <button type="submit" class="col btn btn-outline-success">Answer</button>
            </div>
            {%  endbuttons %}

        </div>
    </form>
</div>

<script src="https://unpkg.com/centrifuge@5.0.1/dist/centrifuge.js"></script>
<script type="text/javascript">
    const centrifuge = new Centrifuge("{{ centrifugo.ws_url }}", {
        token: "{{ centrifugo.token }}"
    });

    centrifuge.on('connecting', function (ctx) {
        console.log(`connecting: ${ctx.code}, ${ctx.reason}`);
    }).on('connected', function (ctx) {
        console.log(`connected over ${ctx.transport}`);
    }).on('disconnected', function (ctx) {
        console.log(`disconnected: ${ctx.code}, ${ctx.reason}`);
    }).connect();

    const sub = centrifuge.newSubscription('{{ centrifugo.channel }}');

    sub.on('publication', function (ctx) {
        const data = ctx.data; 

        console.log('New answer data:', data);

        const answersContainer = document.querySelector('.answers');
        if (!answersContainer) {
            const questionsContainer = document.querySelector('.question-container');
            const newAnswersContainer = document.createElement('div');
            newAnswersContainer.className = 'answers d-flex flex-column gap-3 rounded-0 pb-3 border-bottom border-2 border-dark';
            questionsContainer.insertBefore(newAnswersContainer, questionsContainer.querySelector('form'));
        }
        const answerHtml = `
            <div class="answer-card card w-100" id="answer-${data.id}" data-is-liked="false" style="width: 18rem;">
                <div class="card-body">
                    <div class="row">
                        <div class="col-2">
                            <div class="mb-2" style="height: 130px">
                                <img src="/static/img/default_avatar.png" alt="Avatar" class="rounded-1 img-fluid h-100 w-100 object-fit-cover">
                            </div>
                            <button class="like-button">
                                <div class="heart"></div>
                                <div class="like-count">0</div>
                            </button>
                        </div>
                        <div class="col-10">
                            <p class="card-text">${data.content.replace(/\n/g, '<br>')}</p>
                            <div class="d-flex align-items-center gap-3">
                                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ–∫–±–æ–∫—Å–∞ "helpful" -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const container = document.querySelector('.answers');
        container.insertAdjacentHTML("afterbegin", answerHtml);

    }).on('subscribing', function (ctx) {
        console.log(`subscribing: ${ctx.code}, ${ctx.reason}`);
    }).on('subscribed', function (ctx) {
        console.log('subscribed', ctx);
    }).on('unsubscribed', function (ctx) {
        console.log(`unsubscribed: ${ctx.code}, ${ctx.reason}`);
    }).subscribe();

</script>

{% endblock %}

// –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ–º HTML –¥–ª—è –Ω–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
// const answerHtml = `
//     <div class="card w-100" style="width: 18rem;">
//         <div class="card-body">
//             <div class="row">
//                 <div class="col-3">
//                     <div class="border mb-2 d-inline-block">
//                         <img src="${data.author.avatar ? data.author.avatar : '{% static 'img/jpg.jpg' %}'}"
//                              alt="Avatar" class="img-thumbnail" style="height: 100px;">
//                     </div>
//                     ${data.author.name}
//                     <div class="like-section d-flex align-items-center gap-2">
//                         <button class="btn btn-outline-success" data-type="answer" data-id="${data.id}" type="button"
//                                 style="display: inline-flex; align-items: center;">
//                             üëç
//                         </button>
//                         <span class="rating">Likes:</span>
//                         <span class="rating">${data.likes_count}</span>
//                     </div>
//                 </div>
//                 <div class="col-9">
//                     <p class="card-text">${data.content}</p>
//                     ${data.is_correct ?
//                         `<div class="correct-answer-sticker d-flex align-items-center gap-2">
//                             <span class="badge bg-success">‚úÖ Correct!</span>
//                         </div>`
//                         : ''}
//                 </div>
//             </div>
//         </div>
//     </div>
// `;